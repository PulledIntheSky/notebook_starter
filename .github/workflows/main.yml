name: Docker Selenium Screenshot Test with Cloudflare Bypass

on:
  push:
    branches:
      - main

jobs:
  run_containers:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create screenshots directory
        run: mkdir -p screenshots

      - name: Run Single Docker Container
        run: |
          docker run -d --name container_test --network host selenium/standalone-chrome:latest bash -c "\
            apt-get update && \
            apt-get install -y python3-pip && \
            pip3 install selenium undetected-chromedriver && \
            mkdir -p /tmp/screenshots && \
            python3 -c '\
              import undetected_chromedriver.v2 as uc; \
              from selenium.webdriver.common.by import By; \
              import time; \
              options = uc.ChromeOptions(); \
              options.add_argument(\"--headless\"); \
              options.add_argument(\"--no-sandbox\"); \
              options.add_argument(\"--disable-dev-shm-usage\"); \
              driver = uc.Chrome(options=options); \
              driver.get(\"https://www.whatismyipaddress.com\"); \
              time.sleep(10); \
              screenshot_path = \"/tmp/screenshots/screenshot_test.png\"; \
              driver.save_screenshot(screenshot_path); \
              driver.quit(); \
              print(f\"Screenshot saved to {screenshot_path}\")' && \
              ls -l /tmp/screenshots"
          sleep 60
          docker cp container_test:/tmp/screenshots/. screenshots/container_test/
          docker logs container_test
          ls -R screenshots
